!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("axios"),require("sip.js")):"function"==typeof define&&define.amd?define(["axios","sip.js"],t):e["@wazo/sdk"]=t(e.axios,e.SIP)}(this,function(e,t){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;var s={server:null,token:null};var n=t=>{const n=`https://${s.server}/api/auth/0.1/token`,i={backend:t.backend||"wazo_user",expiration:t.expiration||3600},o={auth:{username:t.username,password:t.password}};e.post(n,i,o).then(e=>((e,t)=>{s.token=e.data.data.token,t&&t(s.token)})(e,t.callback))};var i=t=>{if(s.token){const n=`https://${s.server}/api/auth/0.1/token/${s.token}`;e.delete(n).then((e=>{s.token=null,e&&e(s.token)})(t.callback))}};const o=(e,t)=>{s.data=e.data,404===e&&(s.data={error:"Token is not found"}),204===e&&(s.data={message:"Token is found"}),t&&t(s.data)};const a=["STATUS_NULL","STATUS_NEW","STATUS_CONNECTING","STATUS_CONNECTED","STATUS_COMPLETED"];class r{constructor(e,t){this.target=t,this.type=e}}class c extends r{constructor(e,t){super("error",t),this.message=e.message,this.error=e}}class h extends r{constructor(e=1e3,t="",s){super("close",s),this.wasClean=!0,this.code=e,this.reason=t}}const l=()=>{if("undefined"!=typeof WebSocket)return WebSocket},d=e=>"function"==typeof e&&2===e.CLOSING,u={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1};class p{constructor(e,t,s={}){this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this.eventToHandler=new Map([["open",this._handleOpen.bind(this)],["close",this._handleClose.bind(this)],["error",this._handleError.bind(this)],["message",this._handleMessage.bind(this)]]),this.onclose=void 0,this.onerror=void 0,this.onmessage=void 0,this.onopen=void 0,this._url=e,this._protocols=t,this._options=s,this._connect()}static get CONNECTING(){return 0}static get OPEN(){return 1}static get CLOSING(){return 2}static get CLOSED(){return 3}get CONNECTING(){return p.CONNECTING}get OPEN(){return p.OPEN}get CLOSING(){return p.CLOSING}get CLOSED(){return p.CLOSED}get binaryType(){return this._ws?this._ws.binaryType:this._binaryType}set binaryType(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)}get retryCount(){return Math.max(this._retryCount,0)}get bufferedAmount(){return this._ws?this._ws.bufferedAmount:0}get extensions(){return this._ws?this._ws.extensions:""}get protocol(){return this._ws?this._ws.protocol:""}get readyState(){return this._ws?this._ws.readyState:p.CONNECTING}get url(){return this._ws?this._ws.url:""}close(e,t){this._shouldReconnect=!1,this._ws&&this._ws.readyState!==this.CLOSED&&this._ws.close(e,t)}reconnect(e,t){this._shouldReconnect=!0,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED||this._connect(),this._disconnect(e,t),this._connect()}send(e){this._ws&&this._ws.send(e)}addEventListener(e,t){this._listeners[e]&&this._listeners[e].push(t)}removeEventListener(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(e=>e!==t))}_debug(...e){this._options.debug&&console.log("RWS>",...e)}_getNextDelay(){let e=0;if(this._retryCount>0){const{reconnectionDelayGrowFactor:t=u.reconnectionDelayGrowFactor,minReconnectionDelay:s=u.minReconnectionDelay,maxReconnectionDelay:n=u.maxReconnectionDelay}=this._options;(e=s+Math.pow(this._retryCount-1,t))>n&&(e=n)}return this._debug("next delay",e),e}_wait(){return new Promise(e=>{setTimeout(e,this._getNextDelay())})}_getNextUrl(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){const t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")}_connect(){if(this._connectLock)return;this._connectLock=!0;const{maxRetries:e=u.maxRetries,connectionTimeout:t=u.connectionTimeout,WebSocket:s=l()}=this._options;if(this._retryCount>=e)this._debug("max retries reached",this._retryCount,">=",e);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),!d(s))throw Error("No valid WebSocket class provided");this._wait().then(()=>this._getNextUrl(this._url)).then(e=>{this._debug("connect",{url:e,protocols:this._protocols}),this._ws=new s(e,this._protocols),this._ws.binaryType=this._binaryType,this._connectLock=!1,this._addListeners(),this._connectTimeout=setTimeout(()=>this._handleTimeout(),t)})}}_handleTimeout(){this._debug("timeout event"),this._handleError(new c(Error("TIMEOUT"),this))}_disconnect(e,t){if(clearTimeout(this._connectTimeout),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new h(e,t,this))}catch(e){}}}_acceptOpen(){this._retryCount=0}_handleOpen(e){this._debug("open event");const{minUptime:t=u.minUptime}=this._options;clearTimeout(this._connectTimeout),this._uptimeTimeout=setTimeout(()=>this._acceptOpen(),t),this._debug("assign binary type"),this._ws.binaryType=this._binaryType,this.onopen&&this.onopen(e),this._listeners.open.forEach(t=>t(e))}_handleMessage(e){this._debug("message event"),this.onmessage&&this.onmessage(e),this._listeners.message.forEach(t=>t(e))}_handleError(e){this._debug("error event",e.message),this._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),this.onerror&&this.onerror(e),this._debug("exec error listeners"),this._listeners.error.forEach(t=>t(e)),this._connect()}_handleClose(e){this._debug("close event"),this.onclose&&this.onclose(e),this._listeners.close.forEach(t=>t(e))}_removeListeners(){if(this._ws){this._debug("removeListeners");for(const[e,t]of this.eventToHandler)this._ws.removeEventListener(e,t)}}_addListeners(){this._debug("addListeners");for(const[e,t]of this.eventToHandler)this._ws.addEventListener(e,t)}}return{client:class{constructor(e){this.logIn=n,this.logOut=i,this.server=e}},init:e=>{s.server=e.server},logIn:n,logOut:i,checkAuth:t=>{const n=`https://${s.server}/api/auth/0.1/token/${t.token}`;e.head(n,{validateStatus:e=>{o(e,t.callback)}}).then(e=>o(e,t.callback)).catch(e=>o(e,t.callback))},calls:t=>{const n=`https://${s.server}/api/ctid-ng/1.0/applications/${t.applicationUuid}/calls`,i={headers:{"X-Auth-Token":t.token,"Content-Type":"application/json"}};e.get(n,i).then(e=>((e,t)=>{s.data=e.data,t&&t(s.data)})(e,t.callback))},hangupCall:t=>{const n=`https://${s.server}/api/ctid-ng/1.0/applications/${t.applicationUuid}/calls/${t.callID}`,i={headers:{"X-Auth-Token":t.token,"Content-Type":"application/json"}};e.delete(n,i).then(e=>((e,t)=>{s.data=e.data,t&&t(s.data)})(e,t.callback))},answerCall:t=>{const n=`https://${s.server}/api/ctid-ng/1.0/applications/${t.applicationUuid}/nodes`,i={calls:[{id:t.callID}]},o={headers:{"X-Auth-Token":t.token,"Content-Type":"application/json"}};e.post(n,i,o).then(i=>{const a=i.data.uuid;e.post(`${n}/${a}/calls`,{context:"default",exten:"8000",autoanswer:!0},o).then(e=>{((e,t)=>{s.data=e.data,t&&t(s.data)})(e,t.callback)})})},listNodes:t=>{const n=`https://${s.server}/api/ctid-ng/1.0/applications/${t.applicationUuid}/nodes`,i={headers:{"X-Auth-Token":t.token,"Content-Type":"application/json"}};e.get(n,i).then(e=>((e,t)=>{s.data=e.data,t&&t(s.data)})(e,t.callback))},listCallsNodes:t=>{const n=`https://${s.server}/api/ctid-ng/1.0/applications/${t.applicationUuid}/nodes/${t.nodeUuid}`,i={headers:{"X-Auth-Token":t.token,"Content-Type":"application/json"}};e.get(n,i).then(e=>((e,t)=>{s.data=e.data,t&&t(s.data)})(e,t.callback))},removeCallNodes:t=>{const n=`https://${s.server}/api/ctid-ng/1.0/applications/${t.applicationUuid}/nodes/${t.nodeUuid}/calls/${t.callId}`,i={headers:{"X-Auth-Token":t.token,"Content-Type":"application/json"}};e.delete(n,i).then(e=>((e,t)=>{s.data=e.data,t&&t(s.data)})(e,t.callback))},playCall:t=>{const n=`https://${s.server}/api/ctid-ng/1.0/applications/${t.applicationUuid}/calls/${t.callID}/play`,i={headers:{"X-Auth-Token":t.token,"Content-Type":"application/json"}},o={language:t.language,uri:t.uri};e.post(n,o,i).then(e=>((e,t)=>{s.data=e.data,t&&t(s.data)})(e,t.callback))},WebRTCPhone:class{constructor(e,t){this.config=e,this.ua=this.configureUa(),this.callback=t}configureUa(){const e=new t.Web.Simple(this.getConfig());return e.on("registered",()=>{this.callback("phone-events-registered")}),e.on("unregistered",()=>{this.callback("phone-events-unregistered")}),e.on("new",e=>{const t={callerid:function(e){return{caller_id_name:e.remoteIdentity.displayName,caller_id_number:e.remoteIdentity.uri.user}}(e),autoanswer:function(e){return!!e.getHeader("alert-info")}(e.request)};this.callback("phone-events-new",t)}),e.on("ringing",()=>{this.callback("phone-events-ringing")}),e.on("connected",()=>{this.callback("phone-events-connected")}),e.on("ended",()=>{this.callback("phone-events-ended")}),e}getConfig(){return{media:{remote:{audio:this.config.media.audio}},ua:{traceSip:!1,displayName:this.config.displayName,uri:this.config.uri,wsServers:this.config.wsServers,authorizationUser:this.config.authorizationUser,password:this.config.password,sessionDescriptionHandlerFactoryOptions:{peerConnectionOptions:{iceCheckingTimeout:500,rtcpMuxPolicy:"negotiate",rtcConfiguration:{iceServers:{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"]}}}}}}}getState(){return a[this.ua.state]}call(e){/^\+?[0-9#*]+$/.exec(e)&&this.ua.call(e)}answer(){this.ua.answer()}reject(){this.ua.reject()}hangup(){this.ua.hangup()}},WazoWebSocket:class{constructor(e,t){this.ws_init=!1,this.callback=t,this.host=e.host,this.token=e.token}init(){const e=new p(`wss://${this.host}/api/websocketd/?token=${this.token}`);return e.debug=!1,e.onmessage=(t=>{const s=JSON.parse(t.data);this.ws_init?this.callback(s):this.initialize(s,e)}),e.onclose=(e=>{e.code}),e}initialize(e,t){const s=["*"];switch(e.op){case"init":for(let e=0;e<s.length;e+=1){const n={op:"subscribe",data:{event_name:s[e]}};t.send(JSON.stringify(n))}t.send(JSON.stringify({op:"start"}));break;case"subscribe":break;case"start":this.ws_init=!0}}}}});
